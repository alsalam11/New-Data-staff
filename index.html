<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نموذج بيانات الموظف</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      direction: rtl;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
  <h2>نموذج بيانات الموظف</h2>

  <form id="employeeForm">
    <label>الاسم الرباعي واللقب:</label>
    <input type="text" id="fullName" required>

    <label>اسم الأم الثلاثي:</label>
    <input type="text" id="motherName" required>

    <label>تاريخ التولد:</label>
    <input type="date" id="birthDate" required>

    <label>الجنس:</label>
    <select id="gender" required>
      <option value="">-- اختر --</option>
      <option value="ذكر">ذكر</option>
      <option value="أنثى">أنثى</option>
    </select>

    <label>التحصيل الدراسي:</label>
    <input type="text" id="education" required>

    <label>اسم الكلية أو المعهد:</label>
    <input type="text" id="institute" required>

    <label>الاختصاص الدقيق:</label>
    <input type="text" id="specialization" required>

    <label>تاريخ أمر التعيين:</label>
    <input type="date" id="appointmentDate" required>

    <label>تاريخ المباشرة لأول مرة:</label>
    <input type="date" id="startDate" required>

    <label>اسم المدرسة:</label>
    <input type="text" id="school" required>

    <label>الصورة الشخصية:</label>
    <input type="file" id="photo" accept="image/*">

    <label>صورة وجه البطاقة:</label>
    <input type="file" id="idFront" accept="image/*">

    <label>صورة ظهر البطاقة:</label>
    <input type="file" id="idBack" accept="image/*">

    <button type="submit">إرسال وطباعة + تحميل نسخة</button>
  </form>

  <script>
    document.getElementById("employeeForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const data = {
        fullName: document.getElementById("fullName").value,
        motherName: document.getElementById("motherName").value,
        birthDate: document.getElementById("birthDate").value,
        gender: document.getElementById("gender").value,
        education: document.getElementById("education").value,
        institute: document.getElementById("institute").value,
        specialization: document.getElementById("specialization").value,
        appointmentDate: document.getElementById("appointmentDate").value,
        startDate: document.getElementById("startDate").value,
        school: document.getElementById("school").value
      };

      const photoInput = document.getElementById("photo").files[0];
      const idFront = document.getElementById("idFront").files[0];
      const idBack = document.getElementById("idBack").files[0];

      const readImage = (file) => {
        return new Promise((resolve) => {
          if (!file) return resolve("");
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
      };

      Promise.all([readImage(photoInput), readImage(idFront), readImage(idBack)]).then(([photoURL, frontURL, backURL]) => {
        generatePDF(data, photoURL, frontURL, backURL);
      });

      // إرسال البيانات إلى Google Sheets
      fetch("https://script.google.com/macros/s/AKfycbxMB0MNhhhqLBth0QH6HPJm9tfJ7_oZkbFCysgCHL2zAIJ_-Oe7I5H6CnkaKKBMGW6NCg/exec", {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      }).then(res => res.text()).then(result => {
        console.log("✅ تم الإرسال إلى Google Sheets");
      }).catch(err => {
        console.error("❌ فشل الإرسال إلى Google Sheets", err);
      });

      // حفظ نسخة CSV
      const csvHeader = "الاسم,اسم الأم,تاريخ التولد,الجنس,التحصيل الدراسي,الكلية,الاختصاص,أمر التعيين,المباشرة,المدرسة\n";
      const csvRow = `${data.fullName},${data.motherName},${data.birthDate},${data.gender},${data.education},${data.institute},${data.specialization},${data.appointmentDate},${data.startDate},${data.school}`;
      const blob = new Blob([csvHeader + csvRow], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "بيانات_الموظف.csv";
      link.click();
    });

    async function generatePDF(data, photoURL, frontURL, backURL) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont("Arial");
      doc.setFontSize(12);
      doc.text("استمارة بيانات الموظف", 105, 20, { align: "center" });

      const labels = {
        fullName: "الاسم الرباعي واللقب",
        motherName: "اسم الأم الثلاثي",
        birthDate: "تاريخ التولد",
        gender: "الجنس",
        education: "التحصيل الدراسي",
        institute: "اسم الكلية أو المعهد",
        specialization: "الاختصاص الدقيق",
        appointmentDate: "تاريخ أمر التعيين",
        startDate: "تاريخ المباشرة لأول مرة",
        school: "اسم المدرسة"
      };

      let y = 30;
      for (let key in data) {
        doc.text(`${labels[key]}: ${data[key]}`, 20, y);
        y += 10;
      }

      const addImage = (label, imgData) => {
        if (!imgData) return;
        doc.text(label, 20, y);
        doc.addImage(imgData, "JPEG", 20, y + 5, 50, 40);
        y += 50;
      };

      addImage("الصورة الشخصية:", photoURL);
      addImage("وجه البطاقة:", frontURL);
      addImage("ظهر البطاقة:", backURL);

      doc.save("بيانات_الموظف.pdf");
    }
  </script>
</body>
</html>
